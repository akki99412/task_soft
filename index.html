<!doctype html>
<html>

<head>
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Material+Icons" />






    <link rel="stylesheet" type="text/css"
        href="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);
    </script>


    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.themes.css" type="text/css" />


    <script src="key_file.js" charset="UTF-8">
    </script>
    <script src="useCases/encrypt.js" charset="UTF-8">
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&display=swap" rel="stylesheet">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.3.4/lib/darkmode-js.min.js"></script>
    <script>
        new Darkmode().showWidget();
    </script>
    <div id="spreadsheet"></div>
    <button type=button id="saveButton">
        save
    </button>
    <button type=button id="exportJsonButton">
        export JSON
    </button>
    <button type=button id="$importJsonButton">
        import JSON
    </button>
    <button type=button id="loadButton">
        load
    </button>
    <div class="json">
        <textarea id="$json" cols="100" rows="50">
    </textarea>
    </div>




    </script>
    <script src="utilities/compose.js" charset="UTF-8"></script>
    <script src="utilities/pipe.js" charset="UTF-8"></script>
    <script src="utilities/utilities.js" charset="UTF-8"></script>
    <script src="utilities/timeline.js" charset="UTF-8"></script>
    <script src="utilities/DiContainer.js" charset="UTF-8"></script>


    <script src="properties/const_values.js" charset="UTF-8"></script>
    <script src="properties/template_data_source.js" charset="UTF-8"></script>

    <script src="repositories/secretKeyTimeline.js" charset="UTF-8"></script>
    <script src="repositories/repositories.js" charset="UTF-8"></script>
    <script src="useCases/repositories2table.js" charset="UTF-8"></script>
    <script src="views/views.js" charset="UTF-8"></script>
    <script src="useCases/view2repository.js" charset="UTF-8"></script>
    <script src="repositories/localStrageGetter.js" charset="UTF-8"></script>
    <script src="repositories/localStrageSetter.js" charset="UTF-8"></script>

    <script>
        console.group();
    </script>
    <script src="preview/test.js" charset="UTF-8"></script>
    <script src="utilities/timeline.test.js" charset="UTF-8"></script>
    <script src="repositories/repositories.test.js" charset="UTF-8"></script>
    <script>
        console.groupEnd();
    </script>

    <script>

        document.getElementById("saveButton").onclick = function () {
            clearTimeout(timeoutID);
            c.log("timeoutID cleared")
            delayRepositoryUpdate(repositories.value);
        };
        document.getElementById("exportJsonButton").onclick = function () {
            c.log(JSON.stringify(repositories.value));
            $json.value = (JSON.stringify(repositories.value));
        };
        $importJsonButton.onclick = _ => {
            repositorySetter.next(JSON.parse($json.value));

        }

        document.getElementById("loadButton").onclick = function () {
            clearTimeout(timeoutID);
            c.log("timeoutID cleared")
            getLocalStorage2Timeline(localStorageGetter);
            repositorySetter.next(parseJson2repositories.value);
        };
        const unloadFunction = e => {
            e.preventDefault();
            e.returnValue = "ページを離れようとしています。よろしいですか？"
        }
        const beforeUnloadTimeline = repositories.map(parent =>
            ({ isSaved: false })
        );
        loggerTimelines.push(
            beforeUnloadTimeline.map(a => { c.groupCollapsed("beforeUnloadTimeline"); c.log(a); c.groupEnd(); return a })
        );

        const beforeUnloadTimelineSetter = localStorageSetter.map(parent =>
            beforeUnloadTimeline.next({ isSaved: true })
        );
        loggerTimelines.push(
            beforeUnloadTimelineSetter.map(a => { c.groupCollapsed("beforeUnloadTimelineSetter"); c.log(a); c.groupEnd(); return a })
        );

        const beforeUnloadEventSetter = beforeUnloadTimeline.map(parent => {
            if (parent.isSaved) {
                window.removeEventListener("beforeunload", unloadFunction);
            } else {
                window.addEventListener("beforeunload", unloadFunction);
            }
            return parent.isSaved;
        }
        );
        loggerTimelines.push(
            beforeUnloadEventSetter.map(a => { c.group("beforeUnloadEventSetter"); c.log(a); c.groupEnd(); return a })
        );
    </script>

    <link rel="stylesheet" href="style.css">
</body>

</html>