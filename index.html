<!doctype html>
<html data-bs-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <title>task_soft</title>

    <!-- jspreadsheet -->
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Material+Icons" />
    <link rel="stylesheet" type="text/css"
        href="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);
    </script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.themes.css" type="text/css" />

    <!-- その他 -->
    <script src="key_file.js" charset="UTF-8">
    </script>
    <script src="useCases/encrypt.js" charset="UTF-8">
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic&display=swap" rel="stylesheet">

    <!-- frappe-gantt -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.0/frappe-gantt.min.js"></script>

    <!-- bootstrap -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <!-- <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.3.4/lib/darkmode-js.min.js"></script>
    <script>
        new Darkmode().showWidget();
    </script> -->
    <div id="spreadsheet"></div>
    <div class='gantt-wrap gantt-target dark'>
        <svg class="gantt-target dark" id="gantt"></svg>
    </div>

    <button type=button id="saveButton">
        save
    </button>
    <button type=button id="exportJsonButton">
        export JSON
    </button>
    <button type=button id="$importJsonButton">
        import JSON
    </button>
    <button type=button id="loadButton">
        load
    </button>
    <div class="json">
        <textarea id="$json" cols="100" rows="50">
    </textarea>
    </div>




    </script>
    <script src="utilities/compose.js" charset="UTF-8"></script>
    <script src="utilities/pipe.js" charset="UTF-8"></script>
    <script src="utilities/utilities.js" charset="UTF-8"></script>
    <script src="utilities/timeline.js" charset="UTF-8"></script>
    <script src="utilities/DiContainer.js" charset="UTF-8"></script>


    <script src="properties/const_values.js" charset="UTF-8"></script>
    <script src="properties/template_data_source.js" charset="UTF-8"></script>

    <script src="repositories/secretKeyTimeline.js" charset="UTF-8"></script>
    <script src="repositories/repositories.js" charset="UTF-8"></script>
    <script src="useCases/repositories2table.js" charset="UTF-8"></script>
    <script src="views/views.js" charset="UTF-8"></script>
    <script src="useCases/view2repository.js" charset="UTF-8"></script>
    <script src="repositories/localStrageGetter.js" charset="UTF-8"></script>
    <script src="repositories/localStrageSetter.js" charset="UTF-8"></script>

    <script>
        console.group();
    </script>
    <script src="preview/test.js" charset="UTF-8"></script>
    <script src="utilities/timeline.test.js" charset="UTF-8"></script>
    <script src="repositories/repositories.test.js" charset="UTF-8"></script>
    <script>
        console.groupEnd();
    </script>

    <script>

        document.getElementById("saveButton").onclick = function () {
            clearTimeout(timeoutID);
            c.log("timeoutID cleared")
            delayRepositoryUpdate(repositories.value);
        };
        document.getElementById("exportJsonButton").onclick = function () {
            c.log(JSON.stringify(repositories.value));
            $json.value = (JSON.stringify(repositories.value));
        };
        $importJsonButton.onclick = _ => {
            repositorySetter.next(JSON.parse($json.value));

        }

        document.getElementById("loadButton").onclick = function () {
            clearTimeout(timeoutID);
            c.log("timeoutID cleared")
            getLocalStorage2Timeline(localStorageGetter);
            repositorySetter.next(parseJson2repositories.value);
        };
        const unloadFunction = e => {
            e.preventDefault();
            e.returnValue = "ページを離れようとしています。よろしいですか？"
        }
        const beforeUnloadTimeline = repositories.map(parent =>
            ({ isSaved: false })
        );
        loggerTimelines.push(
            beforeUnloadTimeline.map(a => { c.groupCollapsed("beforeUnloadTimeline"); c.log(a); c.groupEnd(); return a })
        );

        const beforeUnloadTimelineSetter = localStorageSetter.map(parent =>
            beforeUnloadTimeline.next({ isSaved: true })
        );
        loggerTimelines.push(
            beforeUnloadTimelineSetter.map(a => { c.groupCollapsed("beforeUnloadTimelineSetter"); c.log(a); c.groupEnd(); return a })
        );

        const beforeUnloadEventSetter = beforeUnloadTimeline.map(parent => {
            if (parent.isSaved) {
                window.removeEventListener("beforeunload", unloadFunction);
            } else {
                window.addEventListener("beforeunload", unloadFunction);
            }
            return parent.isSaved;
        }
        );
        loggerTimelines.push(
            beforeUnloadEventSetter.map(a => { c.group("beforeUnloadEventSetter"); c.log(a); c.groupEnd(); return a })
        );

        (_ => {
            // タスクを用意
            var tasks = [
                {
                    id: 'id1',
                    name: '確定申告する',
                    description: '必ずやる!!',
                    start: '2021-01-01',
                    end: '2021-01-7',
                    progress: 100,
                    dependencies: "id2, id3"
                },
                {
                    id: 'id2',
                    name: 'クライアントに挨拶',
                    description: '年賀状も確認した上で連絡する',
                    start: '2021-01-4',
                    end: '2021-01-8',
                    progress: 100,
                },
                {
                    id: 'id3',
                    name: '請求書作成',
                    description: 'みんなに稼働時間を記録してもらった上で請求を出す',
                    start: '2021-01-5',
                    end: '2021-01-6',
                    progress: 40,
                },
                {
                    id: 'id4',
                    name: '案件A を開発',
                    description: 'まずはフレームワークのアップデートやる!',
                    start: '2021-01-5',
                    end: '2021-01-11',
                    progress: 50,
                    dependencies: "id1",
                },
                {
                    id: 'id5',
                    name: 'フィードバック面談',
                    description: '各メンバーシートを記入してもらった上で 1on1',
                    start: '2021-01-12',
                    end: '2021-01-16',
                    progress: 20,
                    dependencies: "id1",
                },
            ];

            // gantt をセットアップ
            var gantt = new Gantt("#gantt", tasks, {
                // ダブルクリック時
                on_click: (task) => {
                    console.log(task.description);
                },
                // 日付変更時
                on_date_change: (task, start, end) => {
                    console.log(`${task.name}: change date`);
                },
                // 進捗変更時
                on_progress_change: (task, progress) => {
                    console.log(`${task.name}: change progress to ${progress}%`);
                },
            });
        })();
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>