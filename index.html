<html>
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<script src="https://jsuites.net/v4/jsuites.js"></script>
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Material+Icons" />






<link rel="stylesheet" type="text/css"
    href="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="http://weareoutman.github.io/clockpicker/dist/jquery-clockpicker.min.js"></script>

<!-- <script type="module">
        import data from "./key_file.json" assert { type: "json" };
        console.log(data);
    </script> -->

<script src="key_file.js" charset="UTF-8">
</script>


<div id="spreadsheet"></div>
<button type=button id="save_button">
    save
</button>
<button type=button id="export_button">
    export
</button>
<script>
    var data = [
        ['<span>On his 11th birthday, <b>Harry</b> receives a letter inviting him to study magic at the Hogwarts School of Witchcraft and Wizardry. <b>Harry</b> discovers that not only is he a wizard, but he is a famous one. He meets two best friends, Ron Weasley and Hermione Granger, and makes his first enemy, Draco Malfoy.</span>', 'Jazz', 'Honda', '2019-02-12', '', true, '$ 2.000,00', '#777700'],
        ['Civic', 'Civic', 'Honda', '2018-07-11', '', true, '$ 4.000,01', '#007777', , "10:11"],
    ];

    var clock_editor = {
        // Methods
        closeEditor: function (cell, save) {
            var value = cell.children[0].value;
            cell.innerHTML = value;
            return value;
        },
        openEditor: function (cell) {
            // Create input
            var element = document.createElement('input');
            element.value = cell.innerHTML;
            // Update cell
            cell.classList.add('editor');
            cell.innerHTML = '';
            cell.appendChild(element);
            $(element).clockpicker({
                afterHide: function () {
                    setTimeout(function () {
                        // To avoid double call
                        if (cell.children[0]) {
                            myTable.closeEditor(cell, true);
                        }
                    });
                }
            });
            // Focus on the element
            element.focus();
        },
        getValue: function (cell) {
            return cell.innerHTML;
        },
        setValue: function (cell, value) {
            cell.innerHTML = value;
        }
    }
    const TASK_STATE = Object.freeze({
        SCHEDULED: "計画中",
        SCHEDULED_TODAY: "今日の予定",
        IN_PROGRESS: "実施中",
        COMPLETED_TODAY: "今日完了",
        COMPLETED: "完了",
    });

    var data_template = [
        { header: "名前", member: "title", data_type: "string", table_type: "text", table_width: 200, table_num: 1, table_editor: null, table_source: [] },
        { header: "ID", member: "id", data_type: "string", table_type: "text", table_width: 200, table_num: 2, table_editor: null, table_source: [] },
        { header: "受領日", member: "receipt", data_type: "date", table_type: "calendar", table_width: 200, table_num: 3, table_editor: null, table_source: [] },
        { header: "メモ", member: "memo", data_type: "string", table_type: "html", table_width: 200, table_num: 4, table_editor: null, table_source: [] },
        { header: "タグ", member: "tag", data_type: "string", table_type: "text", table_width: 200, table_num: 5, table_editor: null, table_source: [] },
        { header: "期限", member: "limit", data_type: "date", table_type: "calendar", table_width: 200, table_num: 6, table_editor: null, table_source: [] },
        { header: "予定工数", member: "man_hours", data_type: "numeric", table_type: "numeric", table_width: 200, table_num: 7, table_editor: null, table_source: [] },
        { header: "着手予定日時", member: "scheduled_date_time", data_type: "date", table_type: "hidden", table_width: 200, table_num: 8, table_editor: null, table_source: [] },
        { header: "着手予定日", member: "scheduled_date", data_type: "function", table_type: "calendar", table_width: 200, table_num: 9, table_editor: null, table_source: [] },
        { header: "着手予定時間", member: "scheduled_time", data_type: "function", table_type: "text", table_width: 200, table_num: 9, table_editor: clock_editor, table_source: [] },
        { header: "完了予定日時", member: "completion_date_time", data_type: "date", table_type: "hidden", table_width: 200, table_num: 10, table_editor: null, table_source: [] },
        { header: "完了予定日", member: "completion_date", data_type: "function", table_type: "calendar", table_width: 200, table_num: 11, table_editor: null, table_source: [] },
        { header: "完了予定時間", member: "completion_time", data_type: "function", table_type: "text", table_width: 200, table_num: 12, table_editor: null, table_source: [] },
        { header: "実際の実施日時", member: "implementation_date", data_type: "[date]", table_type: "html", table_width: 200, table_num: 13, table_editor: null, table_source: [] },
        { header: "ステータス", member: "state", data_type: "STATE", table_type: "dropdown", table_width: 200, table_num: 14, table_editor: null, table_source: Object.values(TASK_STATE) },
        { header: "類似タスクid", member: "similar_tasks_id", data_type: "[string]", table_type: "hidden", table_width: 200, table_num: 15, table_editor: null, table_source: [] },
        { header: "類似タスク", member: "similar_tasks", data_type: "function", table_type: "html", table_width: 200, table_num: 16, table_editor: null, table_source: [] },
        { header: "後続タスクid", member: "successor_task_id", data_type: "[string]", table_type: "hidden", table_width: 200, table_num: 17, table_editor: null, table_source: [] },
        { header: "後続タスク", member: "successor_task", data_type: "function", table_type: "html", table_width: 200, table_num: 18, table_editor: null, table_source: [] },
        { header: "内包タスクid", member: "connotative_task_id", data_type: "[string]", table_type: "hidden", table_width: 200, table_num: 19, table_editor: null, table_source: [] },
        { header: "内包タスク", member: "connotative_task", data_type: "function", table_type: "html", table_width: 200, table_num: 20, table_editor: null, table_source: [] },
    ];



    const task_table = jspreadsheet(document.getElementById('spreadsheet'), {
        data: data,
        columns: data_template.map(({ header, member, data_type, table_type, table_width, table_num, table_editor, table_source }) => ({ type: table_type, title: header, width: table_width, editor: table_editor, source: table_source })),

        // [
        //     { type: 'html', title: 'html_test', width: 120 , fadfadfadfs: "ssss"},
        //     { type: 'text', title: 'Car', width: 120 },
        //     { type: 'dropdown', title: 'Make', width: 200, source: ["Alfa Romeo", "Audi", "Bmw"] },
        //     { type: 'calendar', title: 'Available', width: 200 },
        //     { type: 'image', title: 'Photo', width: 120 },
        //     { type: 'checkbox', title: 'Stock', width: 80 },
        //     { type: 'numeric', title: 'Price', width: 100, mask: '$ #.##,00', decimal: ',' },
        //     { type: 'color', width: 100, render: 'square', }
        // ],
        minDimensions: [2, 2]
    });

    // import { nameText } from './import.js';
    function save_file() {
        var headers = task_table.getHeaders();
        var values = task_table.getData();
        console.log(headers)
        console.log(values)
        console.log(`こんにちは${nameText}さん`);

    }
    // localStorage.setItem('localStrageSaveTestKey', 'localStrageSaveTestString');
    // var value = localStorage.getItem('localStrageSaveTestKey');
    // console.log(value);
    async function password_generate_key() {
        // パスワードとして使う文字列。（ユーザーの入力を受け付ける）
        let password = prompt('パスワードを入力して下さい'); // 例：'開けゴマ'

        // 文字列をTyped Arrayに変換する。
        let passwordUint8Array = (new TextEncoder()).encode(password);

        // パスワードのハッシュ値を計算する。
        let digest = await crypto.subtle.digest(
            // ハッシュ値の計算に用いるアルゴリズム。
            { name: 'SHA-256' },
            passwordUint8Array
        );

        // 生パスワードからのハッシュ値から、salt付きでハッシュ化するための素材を得る
        let keyMaterial = await crypto.subtle.importKey(
            'raw',
            digest,
            { name: 'PBKDF2' },
            // 鍵のエクスポートを許可するかどうかの指定。falseでエクスポートを禁止する。
            false,
            // 鍵の用途。ここでは、「鍵の変換に使う」と指定している。
            ['deriveKey']
        );

        // 乱数でsaltを作成する。
        let salt = crypto.getRandomValues(new Uint8Array(16));

        // 素材にsaltを付与して、最終的なWeb Crypto API用の鍵に変換する。
        let secretKey = await crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt,
                iterations: 100000, // ストレッチングの回数。
                hash: 'SHA-256'
            },
            keyMaterial,
            // アルゴリズム。
            { name: 'AES-GCM', length: 256 },
            // 鍵のエクスポートを禁止する。
            false,
            // 鍵の用途は、「データの暗号化と復号に使う」と指定。
            ['encrypt', 'decrypt']
        );

        console.log(secretKey);
        // => CryptoKey { type: "secret", extractable: false, algorithm: {…}, usages: (2) […] }

        // saltの保存。
        localStorage.setItem('passwordSalt',
            JSON.stringify(Array.from(salt)));

    }
    // password_generate_key();
    // saltの復元。
    // let salt = localStorage.getItem('passwordSalt');






    async function auto_generate_key() {
        let secretKey = await crypto.subtle.generateKey(
            // アルゴリズムと鍵長。ここでは最長の256bitを指定している。
            { name: 'AES-GCM', length: 256 },
            // 鍵のエクスポートを許可するかどうか。trueでエクスポートを許可する。
            true,
            // 鍵の用途。
            ['encrypt', 'decrypt']
        );
        console.log(secretKey);
        // => CryptoKey { type: 'secret', extractable: true, algorithm: Object, usages: Array[2] }



        // JSON Web Key（JWK）形式でのエクスポート。
        let exportedSecretKey = await crypto.subtle.exportKey('jwk', secretKey);
        console.log(exportedSecretKey);
        // => Object { alg: "A256GCM", ext: true, k: "DAvha1Scb8jTqk1KUTQlMRdffegdam0AylWRbQTOOfc", key_ops: (2) […], kty: "oct" }
        return exportedSecretKey;
    }

    async function import_secret_key(exportedSecretKey) {
        // JWK形式からのインポート。
        let importedSecretKey = await crypto.subtle.importKey(
            'jwk',
            exportedSecretKey,
            // 鍵を生成した際の暗号アルゴリズム。
            { name: 'AES-GCM' },
            // 再エクスポートを許可するかどうかの指定。falseでエクスポートを禁止する。
            false,
            // 鍵の用途。
            ['encrypt', 'decrypt']
        );
        console.log(importedSecretKey);
        // => CryptoKey { type: 'secret', extractable: true, algorithm: Object, usages: Array[2] }
        return importedSecretKey;
    }
    async function encrypt_string(secretKey, src_string) {

        // データをTyped Arrayに変換。
        let inputData = (new TextEncoder()).encode(src_string);
        console.log(inputData);
        // => Uint8Array(27) [ 230, 154, 151, 229, 143, 183, 229, 140, 150, 227, … ]



        // 初期ベクトルとして、8bit * 16桁 = 128bit分の領域を確保し、乱数で埋める。
        let iv = crypto.getRandomValues(new Uint8Array(16));



        let encryptedArrayBuffer = await crypto.subtle.encrypt(
            // 暗号アルゴリズムの指定とパラメータ。
            {
                name: 'AES-GCM',
                iv
            },
            // 事前に用意しておいた鍵。
            secretKey,
            // ArrayBufferまたはTyped Arrayに変換した入力データ。
            inputData
        );
        console.log(encryptedArrayBuffer);
        // => ArrayBuffer { byteLength: 27 }


        let encryptedBytes = Array.from(new Uint8Array(encryptedArrayBuffer), char => String.fromCharCode(char)).join('');
        console.log(encryptedBytes);
        // => �����`Ù�¥ë�`û-Þm#þ'�¾��[�·�



        let encryptedBase64String = btoa(encryptedBytes);
        console.log(encryptedBase64String);
        // => YPgdHZgguUeHpt9FcYy2IaZTfbTNswbfn93e



        localStorage.setItem('encryptedData',
            JSON.stringify({
                data: encryptedBase64String,
                iv: Array.from(iv)
            }));
        return encryptedBase64String;
    }

    async function decrypt_string() {
        // let encryptedData = JSON.parse(localStorage.getItem('encryptedData'));
        let encryptedBase64String = encryptedData.data;
        // 通常のArrayとして保存しておいた初期ベクトルをUint8Arrayに戻す
        let iv = Uint8Array.from(encryptedData.iv);

        // Base64エンコードされた文字列→Binary String
        let encryptedBytes = atob(encryptedBase64String);

        // Binary String→Typed Array
        let encryptedData = Uint8Array.from(encryptedBytes.split(''), char => char.charCodeAt(0));


        let decryptedArrayBuffer = await crypto.subtle.decrypt(
            // 暗号アルゴリズムの指定とパラメータ。暗号化時と同じ内容を指定する。
            {
                name: 'AES-GCM',
                iv
            },
            // 暗号化の際に使用した物と同じ鍵。
            secretKey,
            // ArrayBufferまたはTyped Arrayに変換した暗号化済みデータ。
            encryptedData
        );
        console.log(decryptedArrayBuffer);
        // => ArrayBuffer { byteLength: 27 }





        let decryptedString = (new TextDecoder()).decode(new Uint8Array(decryptedArrayBuffer));
        console.log(decryptedString);
        // => '暗号化したい文字列'
    }
    function saveTextToFile(text, filename) {
        const blob = new Blob([text], { type: 'text/plain' });
        const blobUrl = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        link.click();
    }
    (async function () {
        if (secret_key_string == "") {
            console.log("generate_key")
            let generated_key = await auto_generate_key();
            console.log("secret_key_string=\'" + JSON.stringify(generated_key) + "\'");
            saveTextToFile("secret_key_string=\'" + JSON.stringify(generated_key) + "\'", "key_file.js")
        } else {
            import_secret_key(JSON.parse(secret_key_string));
        }
    })();


    document.getElementById("save_button").onclick = function () {

    };
    document.getElementById("export_button").onclick = function () {

    };
</script>



</html>